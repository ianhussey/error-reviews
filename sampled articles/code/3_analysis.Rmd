---
title: "Fetching Paper and Journal metadata from Scopus"
author: "Ian Hussey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
    self_contained: true
    code_download: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, include = TRUE, warning = FALSE, message = FALSE)
```

# Download articles and citations

Remember to connect to UniBe VPN (via FortiClient) before running

## Dependencies

```{r}

library(dplyr)
library(tidyr)
library(readr)
library(rscopus)
library(purrr)
library(janitor)
library(knitr)
library(kableExtra)

```

# Summary

## N articles meeting criterion

```{r}

data_publications_summary_overall <- data_publications |>
  drop_na(n_articles_meeting_criterion) |>
  count(n_articles_meeting_criterion) |>
  pivot_wider(names_from = "n_articles_meeting_criterion",
              values_from = "n",
              names_prefix = "n_articles_meeting_criterion_") |>
  rename(n_meeting_threshold = n_articles_meeting_criterion_TRUE,
         n_not_meeting_threshold = n_articles_meeting_criterion_FALSE) |>
  mutate(percent_meeting_threshold = round_half_up(n_meeting_threshold/(n_meeting_threshold + n_not_meeting_threshold)*100, 1))

data_publications_summary_overall |>
  kable() |>
  kable_classic(full_width = FALSE)

```

## N articles meeting criterion by journal

```{r}

data_publications_summary <- data_publications |>
  drop_na(journal, issn, n_articles_meeting_criterion) |>
  count(journal, issn, n_articles_meeting_criterion) |>
  distinct(journal, n_articles_meeting_criterion, n, .keep_all = TRUE) |>
  pivot_wider(names_from = "n_articles_meeting_criterion",
              values_from = "n",
              names_prefix = "n_articles_meeting_criterion_") |>
  rename(n_meeting_threshold = n_articles_meeting_criterion_TRUE,
         n_not_meeting_threshold = n_articles_meeting_criterion_FALSE) |>
  mutate(percent_meeting_threshold = round_half_up(n_meeting_threshold/(n_meeting_threshold + n_not_meeting_threshold)*100, 1)) |>
  mutate(n_meeting_threshold = ifelse(is.na(n_meeting_threshold), 0, n_meeting_threshold),
         percent_meeting_threshold = ifelse(is.na(percent_meeting_threshold), 0, percent_meeting_threshold)) |>
  arrange(desc(percent_meeting_threshold))

data_publications_summary |>
  kable() |>
  kable_classic(full_width = FALSE)

```

## Proportion of journals with no articles meeting criteria

```{r}

data_publications_summary_2 <- data_publications_summary |>
  mutate(no_articles_meeting_criterion = percent_meeting_threshold == 0) |>
  summarize(prop_journals_with_no_articles_meeting_criterion = round_half_up(mean(no_articles_meeting_criterion), 3))

data_publications_summary_2 |>
  kable() |>
  kable_classic(full_width = FALSE)

```

# Other stuff dev

- count articles per subfield, count journals per subfield
- count qualifying articles, journals per subfield (ie: how proportionately represented are the subfields)

TODO

```{r}

# categories_dat <- issn_dat |>
#   mutate(category = tolower(str_remove(category, "PSYCHOLOGY, ")),
#          category = ifelse(category == "psychology", "general", category)) |>
#   select(issn, category, impact_factor_rank)
# 
# dat_combined <- data_publications |>
#   mutate(journal = tolower(journal)) |>
#   full_join(categories_dat, by = "issn")
# 
#  |>
#   drop_na(journal, issn, n_articles_meeting_criterion) |>
#   count(journal, issn, n_articles_meeting_criterion) |>
#   distinct(journal, n_articles_meeting_criterion, n, .keep_all = TRUE) |>
#   pivot_wider(names_from = "n_articles_meeting_criterion",
#               values_from = "n",
#               names_prefix = "n_articles_meeting_criterion_") |>
#   rename(n_meeting_threshold = n_articles_meeting_criterion_TRUE,
#          n_not_meeting_threshold = n_articles_meeting_criterion_FALSE) |>
#   mutate(percent_meeting_threshold = round_half_up(n_meeting_threshold/(n_meeting_threshold + n_not_meeting_threshold)*100, 1)) |>
#   mutate(n_meeting_threshold = ifelse(is.na(n_meeting_threshold), 0, n_meeting_threshold),
#          percent_meeting_threshold = ifelse(is.na(percent_meeting_threshold), 0, percent_meeting_threshold)) |>
#   arrange(desc(percent_meeting_threshold))
# 
# data_publications_summary |>
#   kable() |>
#   kable_classic(full_width = FALSE)

query_return <- rscopus::scopus_search(query = paste0("ISSN(", "2003-2714", ") AND PUBYEAR > ", (2023-1), " AND PUBYEAR < ", (2024+1)),
                                       view = "STANDARD",
                                       max_count = 10000,
                                       count = 200,
                                       verbose = FALSE,
                                       wait_time = 1)

query_return <- rscopus::scopus_search(query = paste0("ISSN(", "2823-9393", ") AND PUBYEAR > ", (2023-1), " AND PUBYEAR < ", (2024+1)),
                                       view = "STANDARD",
                                       max_count = 10000,
                                       count = 200,
                                       verbose = FALSE,
                                       wait_time = 1)

```


# old

## Summarise results

```{r}

data_publications_with_criterion <- data_publications |>
  mutate(citation_count = as.numeric(as.character(citation_count)),
         year = as.numeric(as.character(year)),
         year = ifelse(year > 2023, 2023, year)) |>
  mutate(citations_per_year = round_half_up(citation_count / (2024 - year), 0),
         required_citations_per_year = citations_per_year >= 30) |>
  mutate(journal = tolower(journal),
         journal = case_when(journal == "emotion (washington, d.c.)" ~ "emotion",
                             journal == "journal of research on adolescence : the official journal of the society for research on adolescence" ~ "journal of research on adolescence",
                             journal == "journal of clinical child and adolescent psychology : the official journal for the society of clinical child and adolescent psychology, american psychological association, division 53" ~ "journal of clinical child and adolescent psychology",
                             journal == "personality &amp; social psychology bulletin" ~ "personality and social psychology bulletin",
                             journal == "journal of experimental psychology. human perception and performance" ~ "journal of experimental psychology: human perception and performance",
                             journal == "journal of experimental psychology. general" ~ "journal of experimental psychology: general",
                             journal == "journal of experimental psychology. learning, memory, and cognition" ~ "journal of experimental psychology: learning, memory, and cognition",
                             journal == "journal of experimental psychology: learning memory and cognition" ~ "journal of experimental psychology: learning, memory, and cognition",
                             journal == "journal of experimental psychology. applied" ~ "journal of experimental psychology: applied",
                             journal == "the journal of applied psychology" ~ "journal of applied psychology",
                             #is.na(journal) & issn == "1932-6203" ~ "PLOS ONE",
                             #is.na(journal) & issn == "1095-9920" ~ "organizational behavior and human decision processes",
                             TRUE ~ journal)) |>
  drop_na(journal) |>
  arrange(journal)

# dat <- data_publications_with_criterion |>
#   count(issn, journal)
# 
# data_publications_with_criterion |>
#   count(journal) |>
#   arrange(desc(n))

```

### By journal

PLOS ONE IS MISSING FOR SOME REASON

```{r}

library(stringr)

data_publications_summary <- data_publications_with_criterion |>
  mutate(title = tolower(title)) |>
  filter(!str_detect(title, "meta") & !str_detect(title, "review")) |>
  count(journal, required_citations_per_year) |>
  pivot_wider(names_from = "required_citations_per_year",
              values_from = "n",
              names_prefix = "required_citations_per_year_") |>
  rename(n_meeting_threshold = required_citations_per_year_TRUE,
         n_not_meeting_threshold = required_citations_per_year_FALSE) |>
  mutate(n_meeting_threshold = ifelse(is.na(n_meeting_threshold), 0, n_meeting_threshold),
         n_not_meeting_threshold = ifelse(is.na(n_not_meeting_threshold), 0, n_not_meeting_threshold),
         total_n = n_meeting_threshold + n_not_meeting_threshold,
         percent_meeting_threshold = round_half_up(n_meeting_threshold/(n_meeting_threshold + n_not_meeting_threshold)*100, 1))

data_publications_summary |>
  kable() |>
  kable_classic(full_width = FALSE)

```

### Overall

```{r}

data_publications_summary_overall <- data_publications_with_criterion |>
  mutate(title = tolower(title)) |>
  filter(!str_detect(title, "meta") & !str_detect(title, "review")) |>
  count(required_citations_per_year) |>
  pivot_wider(names_from = "required_citations_per_year",
              values_from = "n",
              names_prefix = "required_citations_per_year_") |>
  rename(n_meeting_threshold = required_citations_per_year_TRUE,
         n_not_meeting_threshold = required_citations_per_year_FALSE) |>
  mutate(n_meeting_threshold = ifelse(is.na(n_meeting_threshold), 0, n_meeting_threshold),
         n_not_meeting_threshold = ifelse(is.na(n_not_meeting_threshold), 0, n_not_meeting_threshold),
         total_n = n_meeting_threshold + n_not_meeting_threshold,
         percent_meeting_threshold = round_half_up(n_meeting_threshold/(n_meeting_threshold + n_not_meeting_threshold)*100, 1))

data_publications_summary_overall |>
  kable() |>
  kable_classic(full_width = FALSE)

```

# Session info

```{r}

sessionInfo()

```

